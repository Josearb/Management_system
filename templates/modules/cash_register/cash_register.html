{% extends "base.html" %}
{% block title %}Registro de Caja{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modules/cash_register.css') }}">
{% endblock %}

{% block content %}
<div class="module-container">
    <h2>üí∞ Registro de Caja</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Bot√≥n para mostrar formulario -->
    <div class="actions" style="margin-bottom: 2rem;">
        <button type="button" id="showFormBtn" class="btn btn-primary">
            ‚ûï Agregar Nuevo Registro
        </button>
    </div>

    <!-- Formulario para nuevos registros (oculto inicialmente) -->
    <div id="registerForm" class="form-section" style="display: none;">
        <h3 style="margin-bottom: 1rem; color: var(--dark-color);">Nuevo Registro de Caja</h3>
        <form action="{{ url_for('cash_register.cash_register') }}" method="post" id="cashForm">
            <div class="form-grid-2">
                <div class="form-group">
                    <label for="transfer_amount">Transferencia ($)</label>
                    <input type="number" step="0.01" id="transfer_amount" name="transfer_amount" 
                           placeholder="0.00" required min="0" class="form-control" value="0">
                </div>
                
                <div class="form-group">
                    <label for="cash_amount">Efectivo ($)</label>
                    <input type="number" step="0.01" id="cash_amount" name="cash_amount" 
                           placeholder="0.00" required min="0" class="form-control" value="0">
                </div>
            </div>
            
            <!-- Vista previa del total -->
            <div id="totalPreview" class="total-preview">
                <strong>Total a registrar: <span id="totalAmount" class="total-amount">$0.00</span></strong>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-success">
                    üíæ Guardar Registro
                </button>
                <button type="button" id="cancelFormBtn" class="btn btn-secondary">
                    ‚ùå Cancelar
                </button>
            </div>
        </form>
    </div>

    <!-- Tabla de registros existentes -->
    <div class="mb-4">
        <h3>üìã Historial de Registros</h3>
        {% if today_records %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Fecha</th>
                    <th>Hora</th>
                    <th>Transferencia</th>
                    <th>Efectivo</th>
                    <th>Total</th>
                    <th>Usuario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for record in today_records %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ record.date.strftime('%H:%M') }}</td>
                    <td>${{ "%.2f"|format(record.transfer_amount) }}</td>
                    <td>${{ "%.2f"|format(record.cash_amount) }}</td>
                    <td><strong>${{ "%.2f"|format(record.total_amount) }}</strong></td>
                    <td>{{ record.user.username }}</td>
                    <td>
                        <button type="button" class="btn-small btn-danger delete-register-btn" 
                                data-register-id="{{ record.id }}" 
                                data-register-amount="${{ '%.2f'|format(record.total_amount) }}"
                                data-register-date="{{ record.date.strftime('%d/%m/%Y %H:%M') }}">
                            üóëÔ∏è Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3"><strong>Totales:</strong></td>
                    <td><strong>${{ "%.2f"|format(today_records|sum(attribute='transfer_amount')) }}</strong></td>
                    <td><strong>${{ "%.2f"|format(today_records|sum(attribute='cash_amount')) }}</strong></td>
                    <td><strong>${{ "%.2f"|format(today_records|sum(attribute='total_amount')) }}</strong></td>
                    <td colspan="2"></td>
                </tr>
            </tfoot>
        </table>
        {% else %}
        <div class="empty-state">
            <p>No hay registros de caja disponibles.</p>
        </div>
        {% endif %}
    </div>

    <!-- Acciones de reportes -->
    <div class="actions" style="margin-top: 2rem;">
        <a href="{{ url_for('cash_register.print_cash_register_report') }}" class="btn btn-secondary" target="_blank">
            üìÑ Generar Reporte
        </a>
        <a href="{{ url_for('cash_register.download_cash_register_pdf') }}" class="btn btn-info">
            üì• Descargar PDF
        </a>
    </div>
</div>

<!-- Modal de confirmaci√≥n unificado -->
<div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
        <h3 id="confirmTitle">‚ö†Ô∏è Confirmar Acci√≥n</h3>
        <p id="confirmMessage"></p>
        <div class="confirm-modal-buttons">
            <button id="cancelBtn" class="btn btn-secondary">Cancelar</button>
            <button id="confirmBtn" class="btn btn-danger">Confirmar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const showFormBtn = document.getElementById('showFormBtn');
    const registerForm = document.getElementById('registerForm');
    const cancelFormBtn = document.getElementById('cancelFormBtn');
    const cashForm = document.getElementById('cashForm');
    const transferInput = document.getElementById('transfer_amount');
    const cashInput = document.getElementById('cash_amount');
    const totalPreview = document.getElementById('totalPreview');
    const totalAmount = document.getElementById('totalAmount');

    // Elementos del modal
    const confirmModal = document.getElementById('confirmModal');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmMessage = document.getElementById('confirmMessage');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');

    let currentAction = null;
    let deleteUrl = '';

    // Mostrar formulario al hacer clic en "Agregar"
    showFormBtn.addEventListener('click', function() {
        registerForm.style.display = 'block';
        showFormBtn.style.display = 'none';
        transferInput.focus();
    });

    // Ocultar formulario al hacer clic en "Cancelar"
    cancelFormBtn.addEventListener('click', function() {
        registerForm.style.display = 'none';
        showFormBtn.style.display = 'block';
        cashForm.reset();
        totalPreview.style.display = 'none';
    });

    // Calcular total en tiempo real
    function calculateTotal() {
        const transfer = parseFloat(transferInput.value) || 0;
        const cash = parseFloat(cashInput.value) || 0;
        const total = transfer + cash;
        
        if (total > 0) {
            totalAmount.textContent = `$${total.toFixed(2)}`;
            totalPreview.style.display = 'block';
        } else {
            totalPreview.style.display = 'none';
        }
    }

    transferInput.addEventListener('input', calculateTotal);
    cashInput.addEventListener('input', calculateTotal);

    // Validaci√≥n del formulario con modal de confirmaci√≥n
    cashForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const transfer = parseFloat(transferInput.value) || 0;
        const cash = parseFloat(cashInput.value) || 0;
        
        if (transfer === 0 && cash === 0) {
            alert('‚ö†Ô∏è Debe ingresar al menos un valor en transferencia o efectivo');
            transferInput.focus();
            return false;
        }
        
        if (transfer < 0 || cash < 0) {
            alert('‚ùå Los valores no pueden ser negativos');
            return false;
        }
        
        const total = transfer + cash;
        
        // Mostrar modal de confirmaci√≥n
        confirmTitle.textContent = 'üíæ Confirmar Registro';
        confirmMessage.textContent = `¬øEst√° seguro de que desea guardar este registro?\n\n‚Ä¢ Transferencia: $${transfer.toFixed(2)}\n‚Ä¢ Efectivo: $${cash.toFixed(2)}\n‚Ä¢ Total: $${total.toFixed(2)}`;
        confirmBtn.textContent = 'Guardar';
        confirmBtn.className = 'btn btn-success';
        
        currentAction = 'save';
        showModal();
    });

    // Manejar eliminaci√≥n de registros
    document.querySelectorAll('.delete-register-btn').forEach(button => {
        button.addEventListener('click', function() {
            const registerId = this.getAttribute('data-register-id');
            const registerAmount = this.getAttribute('data-register-amount');
            const registerDate = this.getAttribute('data-register-date');
            
            deleteUrl = "{{ url_for('cash_register.delete_cash_register', register_id=0) }}".replace('0', registerId);
            
            confirmTitle.textContent = 'üóëÔ∏è Eliminar Registro';
            confirmMessage.textContent = `¬øEst√° seguro de que desea eliminar este registro?\n\n‚Ä¢ Fecha: ${registerDate}\n‚Ä¢ Monto: ${registerAmount}\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`;
            confirmBtn.textContent = 'Eliminar';
            confirmBtn.className = 'btn btn-danger';
            
            currentAction = 'delete';
            showModal();
        });
    });

    // Mostrar modal
    function showModal() {
        confirmModal.style.display = 'block';
    }

    // Ocultar modal
    function hideModal() {
        confirmModal.style.display = 'none';
        currentAction = null;
        deleteUrl = '';
    }

    // Bot√≥n Cancelar del modal
    cancelBtn.addEventListener('click', hideModal);

    // Bot√≥n Confirmar del modal
    confirmBtn.addEventListener('click', function() {
        if (currentAction === 'save') {
            // Enviar formulario de guardado
            cashForm.submit();
        } else if (currentAction === 'delete' && deleteUrl) {
            // Redirigir a eliminaci√≥n
            window.location.href = deleteUrl;
        }
        hideModal();
    });

    // Cerrar modal haciendo clic fuera
    window.addEventListener('click', function(e) {
        if (e.target === confirmModal) {
            hideModal();
        }
    });

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && confirmModal.style.display === 'block') {
            hideModal();
        }
        
        if (e.key === 'Escape' && registerForm.style.display === 'block') {
            cancelFormBtn.click();
        }
    });
});
</script>
{% endblock %}