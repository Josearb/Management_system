{% extends "base.html" %}
{% block title %}CRM{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modules/crm.css') }}">
{% endblock %}

{% block content %}
<div class="module-container">
    <h2>üë• M√≥dulo de CRM</h2>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="actions">
        <form action="{{ url_for('crm.crm') }}" method="post" class="inline-form crm-form">
            <input type="text" name="name" placeholder="Nombre" required>
            <input type="email" name="email" placeholder="Email" required>
            <input type="tel" name="phone" placeholder="Tel√©fono" required>
            <button type="submit" class="btn btn-primary">‚ûï Agregar Cliente</button>
        </form>
    </div>
    
    <div class="customer-grid">
        {% for customer in customers %}
        <div class="customer-card">
            <div class="customer-info">
                <h4>{{ customer.name }}</h4>
                <div class="customer-contact">
                    <span>üìß {{ customer.email }}</span>
                    <span>üìû {{ customer.phone }}</span>
                </div>
            </div>
            <div class="customer-actions">
                <form action="{{ url_for('crm.update_customer', customer_id=customer.id) }}" method="post" class="inline-form">
                    <input type="text" name="name" value="{{ customer.name }}" required>
                    <input type="email" name="email" value="{{ customer.email }}" required>
                    <input type="tel" name="phone" value="{{ customer.phone }}" required>
                    <button type="submit" class="btn btn-small">‚úèÔ∏è Actualizar</button>
                </form>
                <button type="button" class="btn btn-small btn-danger delete-customer-btn" 
                        data-customer-id="{{ customer.id }}" 
                        data-customer-name="{{ customer.name }}">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal de confirmaci√≥n personalizado -->
<div id="confirmModal" class="confirm-modal">
    <div class="confirm-modal-content">
        <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
        <p id="confirmMessage"></p>
        <div class="confirm-modal-buttons">
            <button id="cancelBtn" class="btn btn-secondary">Cancelar</button>
            <button id="confirmBtn" class="btn btn-danger">Eliminar</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    let deleteUrl = '';

    // Agregar event listeners a todos los botones de eliminar
    document.querySelectorAll('.delete-customer-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const customerName = this.getAttribute('data-customer-name');
            const customerId = this.getAttribute('data-customer-id');
            
            deleteUrl = "{{ url_for('crm.delete_customer', customer_id=0) }}".replace('0', customerId);
            confirmMessage.textContent = `¬øEst√° seguro de que desea eliminar al cliente "${customerName}"?\n\nEsta acci√≥n eliminar√° permanentemente al cliente del sistema.\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`;
            
            modal.style.display = 'block';
        });
    });

    // Bot√≥n Cancelar
    cancelBtn.addEventListener('click', function() {
        modal.style.display = 'none';
        deleteUrl = '';
    });

    // Bot√≥n Confirmar
    confirmBtn.addEventListener('click', function() {
        if (deleteUrl) {
            // Crear formulario din√°mico para enviar la solicitud POST
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = deleteUrl;
            document.body.appendChild(form);
            form.submit();
        }
    });

    // Cerrar modal haciendo clic fuera del contenido
    window.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            deleteUrl = '';
        }
    });

    // Cerrar modal con tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'block') {
            modal.style.display = 'none';
            deleteUrl = '';
        }
    });
});
</script>
{% endblock %}